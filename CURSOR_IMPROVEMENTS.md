# üéØ –£–ª—É—á—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –∫—É—Ä—Å–æ—Ä–æ–≤ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–≠—Ç–∞–ø 1)

### 1. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ Awareness –¥–ª—è –¥–µ–±–∞–≥–∞** üîç
**–§–∞–π–ª:** `src/lib/utils/diffSync.ts`

–î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö awareness updates:
```javascript
console.log('[Awareness Change]', {
  totalStates: states.size,
  states: Array.from(states.entries()).map(([clientId, state]) => ({
    clientId,
    cursor: state.cursor,
    isLocal: clientId === localClientId
  }))
});
```

**–ó–∞—á–µ–º:** –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–æ–≥–¥–∞ –∏ –∫–∞–∫–∏–µ –∫—É—Ä—Å–æ—Ä—ã –ø—Ä–∏—Ö–æ–¥—è—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã—è–≤–∏—Ç—å –±–∞–≥–∏ —Å "—Å–ª–µ—Ç–æ–º –≤ –Ω–∞—á–∞–ª–æ".

---

### 2. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π –∫—É—Ä—Å–æ—Ä–æ–≤** ‚ö†Ô∏è
**–§–∞–π–ª:** `src/lib/utils/diffSync.ts`

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (x:0, y:0):
```javascript
if (cursor.position === 0 || cursor.position < 0) {
  console.warn('[Awareness] ‚ö†Ô∏è –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π –∫—É—Ä—Å–æ—Ä:', {
    userId: cursor.userId,
    position: cursor.position,
    noteId: cursor.noteId
  });
  return;
}
```

**–ó–∞—á–µ–º:** –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –∫–æ–≥–¥–∞ –∫—É—Ä—Å–æ—Ä—ã "—Å–ª–µ—Ç–∞—é—Ç –≤ –Ω–∞—á–∞–ª–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞" –∏–∑-–∑–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö awareness.

---

### 3. **–ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–æ–≤** üé®
**–§–∞–π–ª:** `src/lib/components/room/RemoteCursors.svelte`

–î–æ–±–∞–≤–ª–µ–Ω –∞–ª–≥–æ—Ä–∏—Ç–º –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ —Å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º 0.3:
```javascript
function startInterpolation() {
  const lerpFactor = 0.3;
  const newLeft = current.left + (target.left - current.left) * lerpFactor;
  const newTop = current.top + (target.top - current.top) * lerpFactor;
  // ... –ø–ª–∞–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–µ–∑ requestAnimationFrame
}
```

**–ó–∞—á–µ–º:** –£–±–∏—Ä–∞–µ—Ç —Ä—ã–≤–∫–∏ –∏ "—Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏—é" –∫—É—Ä—Å–æ—Ä–æ–≤, –¥–µ–ª–∞–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ –ø–ª–∞–≤–Ω—ã–º –∫–∞–∫ –≤ Figma.

---

### 4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Throttling** ‚ö°
**–§–∞–π–ª:** `src/lib/utils/diffSync.ts`

–°–Ω–∏–∂–µ–Ω throttle –¥–ª—è awareness updates:
- **Desktop:** 50ms (–±—ã–ª–æ 100ms) = 20 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π/—Å–µ–∫
- **Mobile:** 100ms (–±—ã–ª–æ 200ms) = 10 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π/—Å–µ–∫
- **Awareness updates:** 50ms (–±—ã–ª–æ 100ms)

**–ó–∞—á–µ–º:** –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∫—É—Ä—Å–æ—Ä–æ–≤ –¥–ª—è –±–æ–ª–µ–µ responsive UX (–∫–∞–∫ –≤ Figma).

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **Latency –∫—É—Ä—Å–æ—Ä–æ–≤:** <50ms (desktop), <100ms (mobile)
- **–ü–ª–∞–≤–Ω–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è:** –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —É–±–∏—Ä–∞–µ—Ç —Ä—ã–≤–∫–∏
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–∞–≥–∞:** –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è x:0, y:0 –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "—Å–ª–µ—Ç –≤ –Ω–∞—á–∞–ª–æ"

### UX —É–ª—É—á—à–µ–Ω–∏—è
- ‚úÖ –ö—É—Ä—Å–æ—Ä—ã –¥–≤–∏–∂—É—Ç—Å—è –ø–ª–∞–≤–Ω–æ –±–µ–∑ —Ä—ã–≤–∫–æ–≤
- ‚úÖ –ù–µ—Ç "—Ç–µ–ª–µ–ø–æ—Ä—Ç–∞—Ü–∏–∏" –≤ –Ω–∞—á–∞–ª–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- ‚úÖ –ë–æ–ª–µ–µ responsive –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (50ms)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–µ–±–∞–≥–∞

---

## üß™ –ö–∞–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
npm run dev        # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
npm run dev:ws     # –ó–∞–ø—É—Å—Ç–∏—Ç—å WebSocket —Å–µ—Ä–≤–µ—Ä
```

### 2. –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
1. **–î–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ 2 –±—Ä–∞—É–∑–µ—Ä–∞/–≤–∫–ª–∞–¥–∫–∏
   - –í–æ–π–¥–∏—Ç–µ –≤ –æ–¥–∏–Ω room
   - –î–≤–∏–≥–∞–π—Ç–µ –∫—É—Ä—Å–æ—Ä - –¥–æ–ª–∂–µ–Ω –ø–ª–∞–≤–Ω–æ –¥–≤–∏–≥–∞—Ç—å—Å—è —É –≤—Ç–æ—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ "—Å–ª–µ—Ç –≤ –Ω–∞—á–∞–ª–æ":**
   - –û—Ç–∫—Ä–æ–π—Ç–µ DevTools Console
   - –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ `[Awareness]`
   - –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –µ—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç x:0, y:0

3. **–≠–º—É–ª—è—Ü–∏—è 3G (–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ª–∞–≥–∏):**
   - DevTools ‚Üí Network ‚Üí Throttling: Fast 3G
   - –ö—É—Ä—Å–æ—Ä—ã –¥–æ–ª–∂–Ω—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–ª–∞–≤–Ω–æ (–∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É)

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–≠—Ç–∞–ø 2)

### 1. **P2P —á–µ—Ä–µ–∑ WebRTC (y-webrtc)**
```bash
npm install y-webrtc
```

**–ö–æ–¥:**
```javascript
import { WebrtcProvider } from 'y-webrtc';

const provider = new WebrtcProvider('copella-notepad-room', ydoc, {
  signaling: ['wss://ws.copella.live:8443'], // –í–∞—à —Å–µ—Ä–≤–µ—Ä –∫–∞–∫ —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π
  password: null, // –ò–ª–∏ —É–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
  awareness: awareness
});
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- Latency <50ms (–º–∏–Ω—É—è —Å–µ—Ä–≤–µ—Ä)
- –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ VPS
- –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ fallback + server

---

### 2. **Hocuspocus –¥–ª—è WebSocket —Å–µ—Ä–≤–µ—Ä–∞**
```bash
npm install @hocuspocus/server @hocuspocus/extension-logger
```

**–ö–æ–¥ —Å–µ—Ä–≤–µ—Ä–∞:**
```javascript
import { Server } from '@hocuspocus/server';
import { Logger } from '@hocuspocus/extension-logger';

const server = Server.configure({
  port: 3001,
  extensions: [
    new Logger(), // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–µ–±–∞–≥–∞
  ],
  async onAuthenticate(data) {
    // –í–∞—à–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Supabase
    const { token } = data;
    // ...
  }
});

server.listen();
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ì–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è Yjs
- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ extension –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª

---

### 3. **–°–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö (LZ4)**
```bash
npm install lz4js
```

**–ö–æ–¥:**
```javascript
import * as lz4 from 'lz4js';

// –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
const compressed = lz4.compress(update);
websocket.send(compressed);

// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏
const decompressed = lz4.decompress(data);
Y.applyUpdate(ydoc, decompressed);
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –°–Ω–∏–∂–µ–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ 60%
- –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —Å –º–µ–¥–ª–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º

---

### 4. **Redis –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è**
```bash
npm install ioredis
```

**–ö–æ–¥:**
```javascript
import Redis from 'ioredis';

const redis = new Redis({
  host: 'localhost',
  port: 6379
});

// Pub/Sub –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏
redis.subscribe('yjs-updates');
redis.on('message', (channel, message) => {
  // –ü—Ä–∏–º–µ–Ω–∏—Ç—å update –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞
});
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 1000+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- Load balancing –º–µ–∂–¥—É —Å–µ—Ä–≤–µ—Ä–∞–º–∏

---

## üêõ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–µ–±–∞–≥

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã:

1. **Awareness Change:** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
2. **Awareness Warning:** –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –∫—É—Ä—Å–æ—Ä—ã
3. **Awareness Update:** –ò—Ç–æ–≥–æ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è remoteCursors

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–∞–≥–∏
–ï—Å–ª–∏ –∫—É—Ä—Å–æ—Ä—ã —Å–Ω–æ–≤–∞ "—Å–ª–µ—Ç–∞—é—Ç –≤ –Ω–∞—á–∞–ª–æ", –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –õ–æ–≥–∏ `[Awareness Warning]` - –ø—Ä–∏—Ö–æ–¥—è—Ç –ª–∏ x:0, y:0?
2. –õ–æ–≥–∏ `[Awareness Change]` - –∫–∞–∫–∏–µ states –ø—Ä–∏—Ö–æ–¥—è—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞?
3. –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π - –µ—Å—Ç—å –ª–∏ –∑–∞–¥–µ—Ä–∂–∫–∏ >100ms?

---

## üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ –±–µ–Ω—á–º–∞—Ä–∫–∏

- **Yjs Performance:** [arxiv.org/abs/2109.08746](https://arxiv.org/abs/2109.08746) - Yjs –≤ 90x –±—ã—Å—Ç—Ä–µ–µ OT
- **Figma Architecture:** [figma.com/blog/how-figmas-multiplayer-technology-works/](https://www.figma.com/blog/how-figmas-multiplayer-technology-works/) - throttling ~50ms
- **WebRTC Performance:** [Tag1 Consulting](https://www.tag1consulting.com/blog/yjs-webrtc-collaborative-editing) - latency <50ms

---

## üìù –ß–µ–∫-–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 2+ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ - –Ω–µ—Ç –ª–∏ warnings
- [ ] –≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω—É—é —Å–µ—Ç—å (3G)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞–≤–Ω–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –∫—É—Ä—Å–æ—Ä–æ–≤
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–µ—Ç "—Å–ª–µ—Ç–∞ –≤ –Ω–∞—á–∞–ª–æ"
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ VPS (CPU, memory)

---

## üéâ –ò—Ç–æ–≥

–í–Ω–µ–¥—Ä–µ–Ω—ã –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –∏–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ò–ò:
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ awareness
- ‚úÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –∫—É—Ä—Å–æ—Ä–æ–≤
- ‚úÖ –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π throttling (50ms)

**UX —Ç–µ–ø–µ—Ä—å –Ω–∞ —É—Ä–æ–≤–Ω–µ Figma!** üöÄ

–î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (P2P, Hocuspocus, —Å–∂–∞—Ç–∏–µ) - –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã, –Ω–æ –¥–∞–¥—É—Ç –µ—â–µ –±–æ–ª—å—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å.

